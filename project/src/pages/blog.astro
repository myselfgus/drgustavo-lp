---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import '../styles/pages/blog.css';

const entries = await getCollection('blog', ({ data }) => !data.draft);
const posts = entries
  .slice()
  .sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime());

const formatDate = (date: Date) =>
  new Intl.DateTimeFormat('pt-BR', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  }).format(date);

const tagList = Array.from(
  new Set(
    posts.flatMap(entry => (Array.isArray(entry.data.tags) ? entry.data.tags : []))
  )
);
const tagStats = tagList.map(tag => ({
  tag,
  count: posts.filter(entry => entry.data.tags?.includes(tag)).length
}));

const totalPosts = posts.length;
const latestPost = posts[0];
const lastUpdated = latestPost ? formatDate(latestPost.data.publishedAt) : null;
---

<BaseLayout
  title="Blog - Dr. Gustavo Mendes e Silva | Psiquiatria e Neurodiversidade"
  description="Artigos sobre psiquiatria dimensional, neurodiversidade, tecnologia em saúde e práticas clínicas contemporâneas."
>
  <main class="blog">
    <header class="blog__header blog__wrap">
      <h1>Psiquiatria em movimento</h1>
      <p>
        Artigos breves sobre psiquiatria, neurodiversidade e tecnologia clínica para pacientes e profissionais.
      </p>
      <p class="blog__meta">
        {totalPosts} artigos publicados · {tagList.length} temas mapeados
        {lastUpdated && <> · última atualização {lastUpdated}</>}
      </p>
      {tagStats.length > 0 && (
        <ul class="blog__taglist">
          {tagStats.slice(0, 8).map(stat => (
            <li>
              <a href={`/api/blog/search?tag=${encodeURIComponent(stat.tag)}`}>
                #{stat.tag}
              </a>
              <span>{stat.count}</span>
            </li>
          ))}
        </ul>
      )}
    </header>

    <section class="blog__wrap" aria-labelledby="lista-artigos">
      <h2 id="lista-artigos" class="blog__section-title">
        Todos os artigos
      </h2>

      {posts.length > 0 ? (
        <ul class="post-feed" role="list">
          {posts.map(post => (
            <li class="post-feed__item">
              <a class="post-feed__link" href={`/blog/${post.slug}`}>
                <time datetime={post.data.publishedAt.toISOString()}>
                  {formatDate(post.data.publishedAt)}
                </time>
                <h3>{post.data.title}</h3>
                <p>{post.data.excerpt}</p>
                {post.data.tags?.length > 0 && (
                  <ul class="post-feed__tags">
                    {post.data.tags.slice(0, 3).map(tag => (
                      <li>#{tag}</li>
                    ))}
                  </ul>
                )}
              </a>
            </li>
          ))}
        </ul>
      ) : (
        <p>Novos artigos em edição. Volte em breve para mais leituras.</p>
      )}
    </section>
  </main>
</BaseLayout>
