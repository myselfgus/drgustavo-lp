---
import '../styles/sections/hero.css';
import CTAButton from './ui/CTAButton.astro';

const heroHighlights = [
  { icon: 'ðŸ“–', text: 'Narrativa da sua histÃ³ria em formato literÃ¡rio' },
  { icon: 'ðŸ“‹', text: 'Manual personalizado do seu tratamento' },
  { icon: 'ðŸŽ¯', text: 'Metas concretas de alta' }
];

const heroQuotesData = [
  {
    text: '"Ele traduziu meu padrÃ£o de pensamento em um plano que finalmente fez sentido para mim e para minha famÃ­lia."',
    author: 'Paciente acompanhado desde 2023'
  },
  {
    text: '"Consultas longas, informes claros e ajustes em tempo real. Senti pela primeira vez que eu comandava o processo."',
    author: 'Profissional de tecnologia, 34 anos'
  },
  {
    text: '"Recebi minha histÃ³ria contada de volta em um texto literÃ¡rio. Tive insights em dias que nÃ£o tive em anos de terapia."',
    author: 'Paciente em acompanhamento'
  },
  {
    text: '"Tive acompanhamento responsÃ¡vel com canabidiol, com ciÃªncia e sem promessas fÃ¡ceis."',
    author: 'Paciente com dor crÃ´nica, 52 anos'
  }
];

const [initialHeroQuote] = heroQuotesData;

const heroPortraitBase = '/images/dr-gustavo-portrait';
const heroPortraitSrcset = [320, 480, 640, 820, 1024, 1280, 1600]
  .map(size => `${heroPortraitBase}-${size}.jpg ${size}w`)
  .join(', ');
const heroPortraitSizes = '(min-width: 1024px) 320px, 60vw';
const heroPortraitFallback = `${heroPortraitBase}-640.jpg`;
---

<section id="hero" class="hero relative overflow-hidden" aria-labelledby="hero-title">
  <div class="hero__background" aria-hidden="true">
    <div class="hero__photo-ambient hero__photo-ambient--1"></div>
    <div class="hero__photo-ambient hero__photo-ambient--2"></div>
    <span class="hero__halo hero__halo--one"></span>
    <span class="hero__halo hero__halo--two"></span>
    <span class="hero__mesh"></span>
  </div>

  <div class="hero__content container relative z-10">
    <div class="hero__grid">
      <div class="hero__copy space-y-6">
        <span class="hero__eyebrow inline-block px-4 py-2 rounded-full bg-accent-sage/10 text-accent-sage text-sm font-medium backdrop-blur-sm border border-accent-sage/20" data-animate="fade-right">
          Psiquiatria com desfecho planejado Â· SÃ£o JosÃ© do Rio Preto
        </span>

        <h1 id="hero-title" class="hero__title" data-animate="fade-right">
          <span class="hero__line block">VocÃª nÃ£o precisa de mais diagnÃ³sticos.</span>
          <span class="hero__line hero__line--bold block bg-gradient-to-r from-accent-petrol to-accent-sage bg-clip-text text-transparent">
            VocÃª precisa se entender.
          </span>
        </h1>

        <div class="hero__identity space-y-1" data-animate="fade-right">
          <span class="hero__name block text-xl font-semibold">Dr. Gustavo Mendes e Silva</span>
          <span class="hero__context block text-sm text-gray-600">Psiquiatra Â· Psicoterapeuta ACT Â· TEA</span>
        </div>

        <p class="hero__lead text-lg leading-relaxed text-gray-700" data-animate="fade-right">
          Consultas de 2 horas onde eu escuto de verdade. VocÃª leva pra casa a narrativa da sua histÃ³ria, um manual personalizado do tratamento e metas concretas para nÃ£o precisar mais de mim.
        </p>

        <div class="hero__highlights grid gap-3 mt-6" data-stagger>
          {heroHighlights.map(item => (
            <div class="flex items-start gap-3 p-3 rounded-lg bg-white/60 backdrop-blur-sm border border-gray-200/50 hover:border-accent-sage/30 transition-all duration-normal hover:shadow-sm">
              <span class="text-2xl flex-shrink-0">{item.icon}</span>
              <span class="text-sm text-gray-700 leading-relaxed">{item.text}</span>
            </div>
          ))}
        </div>

        <div class="hero__actions flex flex-wrap gap-4 pt-4" data-animate="fade-right">
          <CTAButton
            href="https://wa.me/551721101228?text=OlÃ¡,%20vim%20do%20site%20e%20gostaria%20de%20agendar%20uma%20consulta"
            variant="primary"
            size="lg"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Agendar consulta pelo WhatsApp"
            class="hero__cta-modern"
          >
            Agendar consulta
          </CTAButton>
          
          <button 
            type="button"
            data-scroll-target="manifesto"
            class="px-6 py-3 rounded-lg border-2 border-gray-300 text-gray-700 font-semibold hover:border-accent-petrol hover:text-accent-petrol transition-all duration-normal"
          >
            Saiba mais
          </button>
        </div>
      </div>

      <aside class="hero__media" aria-hidden="true">
        <div class="hero__frame relative" data-animate="fade-left">
          <div class="hero__portrait relative rounded-2xl overflow-hidden shadow-xl">
            <img
              src={heroPortraitFallback}
              srcset={heroPortraitSrcset}
              sizes={heroPortraitSizes}
              alt="Retrato do Dr. Gustavo Mendes e Silva"
              loading="eager"
              decoding="async"
              class="w-full h-full object-cover"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-accent-petrol/20 to-transparent"></div>
          </div>
          <span class="hero__ring hero__ring--outer absolute inset-0 rounded-2xl border-2 border-accent-sage/30 transform scale-105 animate-pulse-slow"></span>
          <span class="hero__ring hero__ring--inner absolute inset-0 rounded-2xl border border-accent-petrol/20"></span>
        </div>

        <figure class="hero__quote mt-6 p-5 rounded-xl bg-white/80 backdrop-blur-sm border border-gray-200 shadow-md" data-animate="fade-left" aria-live="polite">
          <blockquote data-hero-quote class="text-sm italic text-gray-700 mb-3 leading-relaxed">
            {initialHeroQuote.text}
          </blockquote>
          <figcaption data-hero-author class="text-xs text-gray-500 font-medium">
            {initialHeroQuote.author}
          </figcaption>
        </figure>
      </aside>
    </div>
  </div>

  <button
    class="hero__scroll absolute bottom-8 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 text-gray-600 hover:text-accent-petrol transition-colors duration-normal group"
    type="button"
    data-scroll-target="manifesto"
    aria-label="Ir para o manifesto"
    data-animate="fade-up"
  >
    <span class="hero__scroll-icon text-3xl animate-bounce" aria-hidden="true">âŒ„</span>
    <span class="hero__scroll-text text-xs uppercase tracking-wider font-medium">ver manifesto</span>
  </button>
</section>

<script define:vars={{ heroQuotes: heroQuotesData }} is:inline>
  if (window.matchMedia('(min-width: 768px)').matches) {
    const heroSection = document.getElementById('hero');

    if (heroSection) {
      const scrollButton = heroSection.querySelector('[data-scroll-target]');
      const quoteFigure = heroSection.querySelector('.hero__quote');
      const quoteText = heroSection.querySelector('[data-hero-quote]');
      const quoteAuthor = heroSection.querySelector('[data-hero-author]');
      const scheduleButton = heroSection.querySelector('.hero__cta');

      // Track schedule button click - Agente IA decide
      if (scheduleButton) {
        scheduleButton.addEventListener('click', async () => {
          // Pixel client-side (fallback)
          if (typeof window.fbq === 'function') {
            window.fbq('track', 'Lead', {
              content_name: 'Schedule Appointment - Hero',
              content_category: 'appointment'
            });
          }

          // Agente server-side (LLM decide qualidade)
          try {
            await fetch('/api/conversion', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                event_type: 'schedule_click',
                event_data: {
                  location: 'hero',
                  button_text: 'Agendar consulta',
                  session_id: sessionStorage.getItem('session_id') || 'unknown'
                }
              })
            });
          } catch (e) {
            console.log('Conversion tracking failed:', e);
          }
        });
      }

      if (quoteFigure && quoteText && quoteAuthor && heroQuotes.length > 1) {
        let quoteIndex = 0;
        const swapDuration = 260;
        const swapInterval = 8000;

        window.setInterval(() => {
          quoteFigure.classList.add('is-swapping');

          window.setTimeout(() => {
            quoteIndex = (quoteIndex + 1) % heroQuotes.length;
            const nextQuote = heroQuotes[quoteIndex];
            quoteText.textContent = nextQuote.text;
            quoteAuthor.textContent = nextQuote.author;
            quoteFigure.classList.remove('is-swapping');
          }, swapDuration);
        }, swapInterval);
      }

      if (scrollButton) {
        const targetId = scrollButton.getAttribute('data-scroll-target');
        scrollButton.addEventListener('click', () => {
          if (!targetId) return;
          const nextSection = document.getElementById(targetId);
          if (nextSection) {
            nextSection.scrollIntoView({ behavior: 'smooth' });
          }
        });

        let hasHidden = false;
        window.addEventListener('scroll', () => {
          if (hasHidden) return;
          if (window.scrollY > 80) {
            hasHidden = true;
            scrollButton.classList.add('hero__scroll--hidden');
          }
        });
      }
    }
  }
</script>
